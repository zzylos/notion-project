# Notion Opportunity Tree Visualizer - Shared VPS Configuration
# Add these location blocks to your existing server block
#
# Prerequisites:
# 1. Built frontend in /var/www/notionvisualizer/dist/
# 2. Backend running on 127.0.0.1:3001
# 3. Systemd service: notion-tree.service
#
# Files:
# - Frontend: /var/www/notionvisualizer/dist/
# - Backend: /var/www/notionvisualizer/server/
# - Config: /var/www/notionvisualizer/.env

# =============================================================================
# ADD TO http {} BLOCK (BEFORE server blocks)
# =============================================================================

# Rate limiting zone for notion API requests (add if not already present)
# limit_req_zone $binary_remote_addr zone=notion_api_limit:10m rate=30r/s;

# Upstream for notion backend
upstream notion_backend {
    server 127.0.0.1:3001;
    keepalive 32;
}

# =============================================================================
# ADD THESE LOCATION BLOCKS TO YOUR EXISTING server {} BLOCK
# =============================================================================

# --- Notion Visualizer Frontend ---
# Redirect /notionvisualizer to /notionvisualizer/ui/
location = /notionvisualizer {
    return 301 /notionvisualizer/ui/;
}

location = /notionvisualizer/ {
    return 301 /notionvisualizer/ui/;
}

# Main UI location - serves the SPA
location /notionvisualizer/ui/ {
    alias /var/www/notionvisualizer/dist/;
    index index.html;

    # Static assets with aggressive caching (hashed filenames)
    location ~* ^/notionvisualizer/ui/assets/.*\.(js|css|woff2?|ttf|eot)$ {
        alias /var/www/notionvisualizer/dist/;
        rewrite ^/notionvisualizer/ui/(.*)$ /$1 break;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Images and other static files
    location ~* ^/notionvisualizer/ui/.*\.(ico|png|jpg|jpeg|gif|svg|webp)$ {
        alias /var/www/notionvisualizer/dist/;
        rewrite ^/notionvisualizer/ui/(.*)$ /$1 break;
        expires 30d;
        add_header Cache-Control "public";
    }

    # SPA fallback - serve index.html for all routes
    try_files $uri $uri/ /notionvisualizer/ui/index.html;
}

# --- Notion Visualizer API ---
# Proxy all API requests to the backend
location /notionvisualizer/api/ {
    # Rate limiting (comment out if you have global rate limiting)
    # limit_req zone=notion_api_limit burst=50 nodelay;

    # Rewrite to remove the prefix before proxying
    rewrite ^/notionvisualizer/api/(.*)$ /api/$1 break;

    proxy_pass http://notion_backend;
    proxy_http_version 1.1;

    # Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Buffering
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
}

# --- Notion Webhook Endpoint ---
# Direct path for Notion webhooks (no rate limiting for reliable delivery)
location = /notionvisualizer/webhook {
    return 301 /notionvisualizer/webhook/;
}

location /notionvisualizer/webhook/ {
    # Rewrite to backend webhook path
    rewrite ^/notionvisualizer/webhook/?(.*)$ /api/webhook/$1 break;

    proxy_pass http://notion_backend;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";

    # Longer timeout for webhook processing
    proxy_read_timeout 120s;
}

# --- Health Check Endpoint ---
location = /notionvisualizer/health {
    rewrite ^/notionvisualizer/health$ /api/health break;

    proxy_pass http://notion_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
}
